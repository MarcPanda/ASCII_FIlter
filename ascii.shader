
uniform int        divX = 16; // nb Of Characters Width
uniform int        divY = 9; // nb Of Characters height
uniform bool       real_colors = true;
uniform bool       brightness_correction = true;
uniform float4     default_color = {0.0,1.0,0.0,1.0}; // Monochrome base color

uniform texture2d  fontTexture;


struct Char {
	float brightness;
	float2 topLeftUV;
	float2 sizeUV;
};





float4 mainImage( VertData v_in ) : TARGET {
	
	static int nbChars = 184;
	static struct Char chars[185] = {
		{ 0.0, float2(0.0, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.030189853, float2(0.2265625, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.030249955, float2(0.79296875, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.030522553, float2(0.056640625, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.032132395, float2(0.6230469, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.032890093, float2(0.14160156, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.033085417, float2(0.39648438, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.033085417, float2(0.31152344, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.03514816, float2(0.0, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.035244748, float2(0.9628906, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.035727702, float2(0.8779297, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.037176557, float2(0.08496094, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.039535508, float2(0.16992188, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.0425663, float2(0.028320312, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.04454962, float2(0.08496094, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.045023985, float2(0.11328125, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.046706807, float2(0.36816406, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.046706807, float2(0.028320312, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.04869013, float2(0.33984375, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.049593784, float2(0.33984375, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.051517006, float2(0.2548828, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.051596425, float2(0.28320312, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.051596425, float2(0.31152344, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.055155244, float2(0.19824219, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.0574176, float2(0.2265625, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.06191442, float2(0.76464844, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.06191442, float2(0.9628906, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.06503751, float2(0.56640625, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.06552046, float2(0.59472656, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.066170834, float2(0.7363281, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.07215729, float2(0.6513672, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.07894008, float2(0.4814453, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.081425674, float2(0.11328125, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.082679205, float2(0.76464844, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.08572502, float2(0.36816406, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.08716314, float2(0.0, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.09180592, float2(0.5097656, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.09785677, float2(0.7363281, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.09809931, float2(0.16992188, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.10300611, float2(0.33984375, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.10308982, float2(0.36816406, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.10308982, float2(0.39648438, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.10355774, float2(0.19824219, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.106693715, float2(0.6513672, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.10728613, float2(0.028320312, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.10968372, float2(0.8496094, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.110359855, float2(0.79296875, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.110653915, float2(0.056640625, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.11070328, float2(0.6796875, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.111658454, float2(0.4248047, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.11183232, float2(0.31152344, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.12382884, float2(0.82128906, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.12808526, float2(0.76464844, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.128873, float2(0.82128906, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.13028966, float2(0.9628906, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.13054724, float2(0.39648438, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.13054724, float2(0.4248047, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.13222148, float2(0.56640625, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.1323846, float2(0.76464844, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.13298132, float2(0.6796875, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.13315304, float2(0.4248047, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.13315304, float2(0.0, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.1381328, float2(0.4814453, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.14102192, float2(0.453125, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.14122155, float2(0.453125, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.14177747, float2(0.9345703, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.14431459, float2(0.11328125, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.14461723, float2(0.19824219, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.14525259, float2(0.16992188, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.14789917, float2(0.056640625, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.1482705, float2(0.76464844, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.14881355, float2(0.5097656, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.15136997, float2(0.28320312, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.15200533, float2(0.4248047, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.15243462, float2(0.4814453, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.15445657, float2(0.2548828, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.15501465, float2(0.31152344, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.15515417, float2(0.6513672, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.15710744, float2(0.14160156, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.15786943, float2(0.59472656, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.15836097, float2(0.36816406, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.15880314, float2(0.4814453, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.15923028, float2(0.19824219, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.16068558, float2(0.2548828, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.16157636, float2(0.2265625, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.16260666, float2(0.8779297, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.16279554, float2(0.53808594, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.16426371, float2(0.056640625, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.16464792, float2(0.08496094, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.16483897, float2(0.8779297, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.16724299, float2(0.028320312, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.17039399, float2(0.33984375, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.17062579, float2(0.53808594, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.17064083, float2(0.82128906, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.17169043, float2(0.14160156, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.17293967, float2(0.4814453, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.17397426, float2(0.59472656, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.175436, float2(0.39648438, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.1786986, float2(0.19824219, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.17921375, float2(0.5097656, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.17953786, float2(0.90625, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.18001868, float2(0.19824219, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.18284984, float2(0.14160156, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.18359251, float2(0.6513672, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.18763644, float2(0.2265625, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.18790689, float2(0.08496094, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.18807001, float2(0.16992188, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.1885315, float2(0.7080078, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.19098276, float2(0.056640625, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.19182631, float2(0.08496094, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.19752514, float2(0.56640625, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.19761315, float2(0.6230469, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.19807033, float2(0.9345703, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.19879799, float2(0.9345703, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.2003563, float2(0.11328125, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.20355238, float2(0.82128906, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.20780236, float2(0.53808594, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.20921901, float2(0.6230469, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.20935638, float2(0.7080078, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.21010764, float2(0.7080078, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.21020637, float2(0.7363281, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.21059704, float2(0.028320312, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.21437265, float2(0.2265625, 0.6152344), float2(0.028320312, 0.123046875) },
		{ 0.21568628, float2(0.8779297, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.21575281, float2(0.2548828, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.21577214, float2(0.9628906, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.21611986, float2(0.5097656, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.21775116, float2(0.56640625, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.2182341, float2(0.0, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.21907552, float2(0.56640625, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.21981604, float2(0.36816406, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.21981604, float2(0.6230469, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.22153535, float2(0.9345703, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.22191098, float2(0.8496094, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.22791247, float2(0.7363281, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.22801764, float2(0.53808594, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.228316, float2(0.9345703, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.22855212, float2(0.2265625, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.23192848, float2(0.453125, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.23199502, float2(0.5097656, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.23380448, float2(0.14160156, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.23609903, float2(0.453125, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.23676658, float2(0.2548828, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.23725383, float2(0.90625, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.23823047, float2(0.8496094, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.23831633, float2(0.79296875, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.23931657, float2(0.056640625, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.23981026, float2(0.8779297, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.24019876, float2(0.79296875, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.24090494, float2(0.28320312, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.24419117, float2(0.59472656, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.24485871, float2(0.16992188, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.24778003, float2(0.7080078, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.25014973, float2(0.6796875, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.2503944, float2(0.90625, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.2535411, float2(0.14160156, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.25368923, float2(0.53808594, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.2558185, float2(0.33984375, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.2595748, float2(0.7363281, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.26150873, float2(0.028320312, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.26309067, float2(0.4248047, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.2647456, float2(0.79296875, 0.4921875), float2(0.028320312, 0.123046875) },
		{ 0.26606995, float2(0.16992188, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.26615795, float2(0.11328125, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.26621163, float2(0.6796875, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.26715177, float2(0.7080078, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.26733422, float2(0.6796875, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.26784292, float2(0.6230469, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.27044228, float2(0.0, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 0.27050668, float2(0.82128906, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.27713922, float2(0.8496094, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.2787469, float2(0.31152344, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.28174764, float2(0.6513672, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.2839134, float2(0.28320312, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.28493083, float2(0.39648438, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.2853966, float2(0.08496094, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.2932569, float2(0.28320312, 0.123046875), float2(0.028320312, 0.123046875) },
		{ 0.29475728, float2(0.9628906, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.29771295, float2(0.90625, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.304294, float2(0.11328125, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.31285402, float2(0.90625, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.3140453, float2(0.453125, 0.0), float2(0.028320312, 0.123046875) },
		{ 0.3316441, float2(0.59472656, 0.36914062), float2(0.028320312, 0.123046875) },
		{ 0.34019768, float2(0.8496094, 0.24609375), float2(0.028320312, 0.123046875) },
		{ 1.1, float2(0, 0), float2(0.1, 0.1) }
	};

	float2 divCount = float2(divX, divY);
	float2 divSize = 1 / divCount;
	
	
	float2 posInImage = v_in.uv;
	
	float2 divTopLeft = floor(posInImage * divCount) / divCount;
	float2 divCenter = divTopLeft + divSize / 2;
	float2 uvInDiv = (posInImage - divTopLeft) / divSize;
	
	
    float4 color = image.Sample(textureSampler, divCenter);
	float gray = 0.3 * color.r + 0.59 * color.g + 0.11 * color.b;

	Char c = chars[nbChars - 1];
	for (int i = 0; i < nbChars; i++) {
		float adjustedBrightness = chars[i].brightness / 0.35 + 0.001;
		if (adjustedBrightness >= gray) {
			c = chars[i];
			break;
		}
	}
	
	float2 fontTextUV = c.topLeftUV + c.sizeUV * uvInDiv;
    float4 fontSample = fontTexture.Sample(textureSampler, fontTextUV);
	float glyphSample = fontSample.r;
	
    if (real_colors) {
		if (brightness_correction) {
			float maxC = max(color.r, max(color.g, color.b));
			color.rgb /= max(c.brightness, maxC);
		}
	}
	else {
        color.rgb = default_color.rgb;
    }
	color.rgb *= glyphSample;
    
    return color;
}